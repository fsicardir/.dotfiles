#!/usr/bin/env bash

. ~/bin/panel/panel_colors.sh
. ~/bin/panel/panel_widgets.sh
. ~/bin/lib/monitors.sh

PANEL_WM_NAME="lemonbar"
PANEL_PID_FILE="/tmp/panel.pid"
PID=$(cat $PANEL_PID_FILE 2>/dev/null)
if [[ ! -z "$PID" ]]; then
	printf "%s\n" "The panel is already running. Killing it." >&2
    kill $PID
fi

echo $$ >$PANEL_PID_FILE

PANEL_FIFO="/tmp/panel-fifo"
[ -e "$PANEL_FIFO" ] && rm "$PANEL_FIFO"
mkfifo "$PANEL_FIFO"

xtitle -sf 'T%s\n' > "$PANEL_FIFO" &
clock -sf 'C%a %d/%m %H:%M:%S' -i 1 > "$PANEL_FIFO" &
cmd_repeat "network" 3 > "$PANEL_FIFO" &
cmd_repeat "bluetooth" 3 > "$PANEL_FIFO" &
cmd_repeat "battery" 5 > "$PANEL_FIFO" &
cmd_repeat "keyboard_layout" 3 > "$PANEL_FIFO" &
bspc subscribe report > "$PANEL_FIFO" &

MONITOR="$(primary_monitor)"
MONITOR_WIDTH=$(monitor_dim "$MONITOR" "width")
BAR_WIDTH=$((MONITOR_WIDTH - 10))
MONITOR_X_OFFSET=$(monitor_dim "$MONITOR" "offset_x")
BAR_X_OFFSET=$((MONITOR_X_OFFSET + 5))
BAR_HEIGHT="25"
MONITOR_Y_OFFSET=$(monitor_dim "$MONITOR" "offset_y")
BAR_Y_OFFSET=$((MONITOR_Y_OFFSET + 5))

bspc config -m "$MONITOR" top_padding 30

SEC_MONITOR="$(secondary_monitor)"
if [[ ! -z "$SEC_MONITOR" ]]; then
    bspc config -m "$SEC_MONITOR" top_padding 0
fi

~/bin/panel/panel_bar < "$PANEL_FIFO" | lemonbar -a 32 -u 2 -n "$PANEL_WM_NAME" -g "${BAR_WIDTH}x${BAR_HEIGHT}+${BAR_X_OFFSET}+${BAR_Y_OFFSET}" -f "Font Awesome" -f "Hack Nerd Font-11" -F "$COLOR_DEFAULT_FG" -B "$COLOR_DEFAULT_BG" | bash &

trap 'trap - TERM; bspc config top_padding 0; kill $(ps -o pid= --ppid $$) &>/dev/null' INT TERM QUIT EXIT

wait
